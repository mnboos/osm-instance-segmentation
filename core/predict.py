import os
from mask_rcnn import model as modellib
from core.mask_rcnn_config import MyMaskRcnnConfig
from core.utils import MarchingSquares, georeference, rectangularize
from typing import Iterable, Tuple, List
from PIL import Image
from pygeotile.tile import Tile
import numpy as np


class Predictor:
    config = MyMaskRcnnConfig()

    class InferenceConfig(config.__class__):
        # Run detection on one image at a time
        GPU_COUNT = 1
        IMAGES_PER_GPU = 1
        IMAGE_MIN_DIM = 256
        IMAGE_MAX_DIM = 256

    def __init__(self, weights_path: str):
        if not os.path.isfile(weights_path):
            raise RuntimeError("Weights cannot be found at: {}".format(weights_path))
        self.weights_path = weights_path
        self._model = None

    def _getpoints(self):
        return [[(185, 94), (186, 94), (187, 94), (188, 94), (189, 94), (190, 94), (190, 95), (190, 96), (191, 96), (192, 96), (192, 97), (192, 98), (193, 98), (193, 99), (194, 99), (194, 100), (195, 100), (195, 101), (196, 101), (196, 102), (197, 102), (197, 103), (198, 103), (198, 104), (199, 104), (200, 104), (200, 105), (201, 105), (202, 105), (202, 106), (203, 106), (203, 107), (204, 107), (205, 107), (205, 108), (206, 108), (207, 108), (207, 109), (208, 109), (208, 110), (209, 110), (209, 111), (210, 111), (211, 111), (211, 112), (212, 112), (212, 113), (213, 113), (213, 114), (214, 114), (214, 115), (215, 115), (216, 115), (216, 116), (217, 116), (218, 116), (218, 117), (219, 117), (219, 118), (220, 118), (220, 119), (221, 119), (222, 119), (222, 120), (223, 120), (223, 121), (223, 122), (223, 123), (223, 124), (223, 125), (222, 125), (222, 126), (222, 127), (221, 127), (221, 128), (221, 129), (220, 129), (220, 130), (219, 130), (219, 131), (218, 131), (218, 132), (217, 132), (217, 133), (216, 133), (216, 134), (215, 134), (215, 135), (214, 135), (214, 136), (213, 136), (213, 137), (212, 137), (212, 138), (211, 138), (211, 139), (210, 139), (209, 139), (209, 140), (208, 140), (208, 141), (207, 141), (206, 141), (206, 142), (205, 142), (204, 142), (203, 142), (202, 142), (201, 142), (201, 143), (200, 143), (199, 143), (198, 143), (197, 143), (197, 142), (196, 142), (195, 142), (194, 142), (193, 142), (192, 142), (192, 141), (191, 141), (190, 141), (189, 141), (189, 140), (188, 140), (187, 140), (186, 140), (185, 140), (184, 140), (184, 139), (183, 139), (182, 139), (181, 139), (181, 138), (180, 138), (180, 137), (179, 137), (178, 137), (178, 136), (177, 136), (177, 135), (176, 135), (176, 134), (175, 134), (175, 133), (174, 133), (174, 132), (173, 132), (173, 131), (172, 131), (171, 131), (171, 130), (170, 130), (170, 129), (169, 129), (168, 129), (168, 128), (167, 128), (167, 127), (167, 126), (166, 126), (166, 125), (166, 124), (166, 123), (166, 122), (166, 121), (167, 121), (167, 120), (167, 119), (168, 119), (168, 118), (168, 117), (169, 117), (169, 116), (170, 116), (170, 115), (171, 115), (171, 114), (172, 114), (172, 113), (173, 113), (173, 112), (173, 111), (174, 111), (174, 110), (175, 110), (175, 109), (175, 108), (176, 108), (176, 107), (176, 106), (177, 106), (177, 105), (177, 104), (178, 104), (178, 103), (178, 102), (179, 102), (179, 101), (180, 101), (180, 100), (181, 100), (181, 99), (182, 99), (182, 98), (182, 97), (183, 97), (183, 96), (184, 96), (184, 95), (185, 95), (185, 94)], [(147, 183), (148, 183), (149, 183), (150, 183), (151, 183), (152, 183), (152, 184), (153, 184), (154, 184), (155, 184), (155, 185), (156, 185), (156, 186), (156, 187), (156, 188), (156, 189), (156, 190), (157, 190), (157, 191), (157, 192), (158, 192), (158, 193), (158, 194), (159, 194), (159, 195), (159, 196), (159, 197), (160, 197), (160, 198), (160, 199), (161, 199), (161, 200), (161, 201), (161, 202), (162, 202), (162, 203), (162, 204), (162, 205), (163, 205), (163, 206), (163, 207), (164, 207), (164, 208), (164, 209), (165, 209), (165, 210), (165, 211), (166, 211), (166, 212), (166, 213), (166, 214), (167, 214), (167, 215), (167, 216), (168, 216), (168, 217), (168, 218), (169, 218), (169, 219), (169, 220), (169, 221), (170, 221), (170, 222), (170, 223), (171, 223), (171, 224), (171, 225), (171, 226), (170, 226), (170, 227), (171, 227), (171, 228), (170, 228), (170, 229), (169, 229), (169, 230), (168, 230), (168, 231), (167, 231), (166, 231), (166, 232), (165, 232), (164, 232), (164, 233), (163, 233), (162, 233), (162, 234), (161, 234), (160, 234), (159, 234), (158, 234), (157, 234), (157, 235), (156, 235), (155, 235), (154, 235), (153, 235), (153, 234), (152, 234), (152, 233), (151, 233), (151, 232), (150, 232), (150, 231), (149, 231), (148, 231), (148, 230), (147, 230), (146, 230), (145, 230), (145, 231), (144, 231), (144, 232), (143, 232), (143, 233), (142, 233), (141, 233), (141, 232), (141, 231), (141, 230), (140, 230), (139, 230), (139, 229), (138, 229), (138, 228), (137, 228), (137, 227), (137, 226), (136, 226), (136, 225), (136, 224), (135, 224), (135, 223), (135, 222), (134, 222), (134, 221), (134, 220), (133, 220), (133, 219), (133, 218), (133, 217), (133, 216), (132, 216), (132, 215), (132, 214), (131, 214), (130, 214), (130, 213), (129, 213), (129, 212), (128, 212), (128, 211), (128, 210), (127, 210), (127, 209), (126, 209), (126, 208), (125, 208), (125, 207), (125, 206), (124, 206), (124, 205), (124, 204), (123, 204), (123, 203), (123, 202), (122, 202), (122, 201), (122, 200), (122, 199), (121, 199), (121, 198), (121, 197), (122, 197), (122, 196), (123, 196), (123, 195), (123, 194), (124, 194), (124, 193), (125, 193), (125, 192), (126, 192), (126, 191), (127, 191), (127, 190), (128, 190), (128, 189), (129, 189), (129, 188), (130, 188), (131, 188), (131, 187), (132, 187), (133, 187), (133, 186), (134, 186), (135, 186), (136, 186), (137, 186), (137, 185), (138, 185), (139, 185), (140, 185), (141, 185), (142, 185), (143, 185), (143, 184), (144, 184), (145, 184), (146, 184), (147, 184), (147, 183)], [(4, 139), (5, 139), (6, 139), (7, 139), (8, 139), (9, 139), (10, 139), (11, 139), (11, 140), (12, 140), (12, 141), (13, 141), (13, 142), (13, 143), (13, 144), (13, 145), (13, 146), (14, 146), (14, 147), (14, 148), (14, 149), (15, 149), (15, 150), (15, 151), (15, 152), (16, 152), (16, 153), (16, 154), (17, 154), (17, 155), (17, 156), (17, 157), (18, 157), (18, 158), (18, 159), (19, 159), (19, 160), (19, 161), (20, 161), (20, 162), (20, 163), (21, 163), (21, 164), (21, 165), (21, 166), (22, 166), (22, 167), (22, 168), (22, 169), (23, 169), (23, 170), (24, 170), (24, 171), (24, 172), (24, 173), (25, 173), (25, 174), (25, 175), (25, 176), (25, 177), (26, 177), (26, 178), (26, 179), (25, 179), (25, 180), (25, 181), (25, 182), (25, 183), (25, 184), (24, 184), (24, 185), (23, 185), (23, 186), (22, 186), (22, 187), (21, 187), (21, 188), (21, 189), (20, 189), (20, 190), (19, 190), (19, 191), (18, 191), (18, 192), (17, 192), (17, 193), (16, 193), (15, 193), (14, 193), (13, 193), (12, 193), (12, 192), (12, 191), (11, 191), (11, 190), (10, 190), (10, 189), (9, 189), (9, 188), (8, 188), (8, 187), (7, 187), (7, 186), (7, 185), (6, 185), (6, 184), (6, 183), (6, 182), (5, 182), (5, 181), (5, 180), (5, 179), (4, 179), (4, 178), (4, 177), (3, 177), (3, 176), (3, 175), (2, 175), (2, 174), (1, 174), (0, 174), (0, 173), (0, 172), (0, 171), (0, 170), (0, 169), (0, 168), (0, 167), (0, 166), (0, 165), (0, 164), (0, 163), (0, 162), (0, 161), (0, 160), (0, 159), (0, 158), (0, 157), (0, 156), (0, 155), (0, 154), (0, 153), (0, 152), (0, 151), (0, 150), (0, 149), (0, 148), (0, 147), (0, 146), (0, 145), (0, 144), (0, 143), (0, 142), (0, 141), (0, 140), (1, 140), (2, 140), (3, 140), (4, 140), (4, 139)], [(57, 108), (58, 108), (59, 108), (60, 108), (61, 108), (62, 108), (63, 108), (64, 108), (65, 108), (66, 108), (66, 109), (67, 109), (67, 110), (68, 110), (68, 111), (69, 111), (69, 112), (70, 112), (70, 113), (71, 113), (72, 113), (72, 114), (73, 114), (73, 115), (74, 115), (74, 116), (75, 116), (75, 117), (76, 117), (76, 118), (77, 118), (78, 118), (78, 119), (79, 119), (79, 120), (80, 120), (80, 121), (81, 121), (81, 122), (81, 123), (82, 123), (83, 123), (83, 124), (84, 124), (84, 125), (85, 125), (85, 126), (86, 126), (86, 127), (87, 127), (87, 128), (88, 128), (88, 129), (89, 129), (89, 130), (90, 130), (90, 131), (90, 132), (91, 132), (91, 133), (90, 133), (90, 134), (90, 135), (89, 135), (89, 136), (89, 137), (88, 137), (88, 138), (87, 138), (86, 138), (85, 138), (85, 139), (84, 139), (84, 140), (83, 140), (83, 141), (82, 141), (82, 142), (81, 142), (81, 143), (80, 143), (80, 144), (79, 144), (79, 145), (79, 146), (78, 146), (78, 147), (77, 147), (77, 148), (76, 148), (75, 148), (74, 148), (73, 148), (72, 148), (71, 148), (70, 148), (69, 148), (68, 148), (67, 148), (66, 148), (65, 148), (65, 147), (64, 147), (64, 146), (63, 146), (62, 146), (62, 145), (61, 145), (61, 144), (60, 144), (60, 143), (59, 143), (59, 142), (58, 142), (58, 141), (57, 141), (57, 140), (56, 140), (56, 139), (55, 139), (55, 138), (54, 138), (54, 137), (53, 137), (53, 136), (52, 136), (51, 136), (51, 135), (50, 135), (50, 134), (49, 134), (49, 133), (48, 133), (48, 132), (47, 132), (47, 131), (46, 131), (46, 130), (46, 129), (46, 128), (45, 128), (45, 127), (45, 126), (45, 125), (46, 125), (46, 124), (46, 123), (46, 122), (46, 121), (47, 121), (47, 120), (47, 119), (47, 118), (48, 118), (48, 117), (48, 116), (49, 116), (49, 115), (50, 115), (50, 114), (50, 113), (51, 113), (51, 112), (52, 112), (52, 111), (53, 111), (53, 110), (54, 110), (55, 110), (55, 109), (56, 109), (57, 109), (57, 108)], [(59, 217), (60, 217), (60, 218), (61, 218), (62, 218), (63, 218), (63, 219), (63, 220), (64, 220), (64, 221), (64, 222), (65, 222), (65, 223), (65, 224), (66, 224), (66, 225), (66, 226), (66, 227), (67, 227), (67, 228), (68, 228), (68, 229), (68, 230), (69, 230), (69, 231), (69, 232), (70, 232), (70, 233), (70, 234), (70, 235), (71, 235), (71, 236), (72, 236), (72, 237), (72, 238), (73, 238), (73, 239), (74, 239), (74, 240), (74, 241), (74, 242), (75, 242), (75, 243), (75, 244), (75, 245), (76, 245), (76, 246), (76, 247), (76, 248), (76, 249), (77, 249), (77, 250), (77, 251), (77, 252), (78, 252), (78, 253), (79, 253), (79, 254), (79, 255), (79, 256), (78, 256), (77, 256), (76, 256), (75, 256), (74, 256), (73, 256), (72, 256), (71, 256), (70, 256), (69, 256), (68, 256), (67, 256), (66, 256), (65, 256), (64, 256), (63, 256), (62, 256), (61, 256), (60, 256), (59, 256), (58, 256), (57, 256), (56, 256), (55, 256), (54, 256), (53, 256), (52, 256), (51, 256), (50, 256), (49, 256), (48, 256), (47, 256), (46, 256), (45, 256), (44, 256), (43, 256), (42, 256), (41, 256), (40, 256), (39, 256), (38, 256), (37, 256), (36, 256), (35, 256), (34, 256), (33, 256), (32, 256), (31, 256), (30, 256), (30, 255), (29, 255), (29, 254), (28, 254), (28, 253), (27, 253), (27, 252), (26, 252), (26, 251), (27, 251), (27, 250), (28, 250), (28, 249), (28, 248), (27, 248), (27, 247), (26, 247), (26, 246), (26, 245), (27, 245), (27, 244), (28, 244), (28, 243), (28, 242), (29, 242), (29, 241), (30, 241), (30, 240), (30, 239), (29, 239), (29, 238), (29, 237), (29, 236), (28, 236), (28, 235), (28, 234), (29, 234), (29, 233), (29, 232), (29, 231), (30, 231), (30, 230), (31, 230), (31, 229), (32, 229), (32, 228), (33, 228), (33, 227), (34, 227), (35, 227), (35, 226), (36, 226), (36, 225), (37, 225), (38, 225), (38, 224), (39, 224), (40, 224), (41, 224), (41, 223), (42, 223), (43, 223), (44, 223), (45, 223), (45, 222), (46, 222), (47, 222), (48, 222), (48, 221), (49, 221), (50, 221), (51, 221), (51, 220), (52, 220), (53, 220), (54, 220), (54, 219), (55, 219), (55, 218), (56, 218), (57, 218), (58, 218), (59, 218), (59, 217)], [(254, 216), (255, 216), (255, 217), (256, 217), (256, 218), (256, 219), (256, 220), (256, 221), (256, 222), (256, 223), (256, 224), (256, 225), (256, 226), (256, 227), (256, 228), (256, 229), (256, 230), (256, 231), (256, 232), (256, 233), (256, 234), (256, 235), (256, 236), (256, 237), (256, 238), (256, 239), (256, 240), (256, 241), (256, 242), (256, 243), (256, 244), (256, 245), (256, 246), (256, 247), (256, 248), (256, 249), (256, 250), (256, 251), (255, 251), (254, 251), (253, 251), (252, 251), (251, 251), (251, 250), (250, 250), (249, 250), (249, 249), (248, 249), (248, 248), (248, 247), (247, 247), (247, 246), (246, 246), (246, 245), (246, 244), (245, 244), (245, 243), (244, 243), (244, 242), (244, 241), (243, 241), (243, 240), (243, 239), (242, 239), (242, 238), (242, 237), (241, 237), (241, 236), (241, 235), (241, 234), (241, 233), (241, 232), (241, 231), (242, 231), (242, 230), (242, 229), (243, 229), (243, 228), (243, 227), (243, 226), (244, 226), (244, 225), (244, 224), (245, 224), (245, 223), (245, 222), (246, 222), (246, 221), (246, 220), (247, 220), (247, 219), (248, 219), (248, 218), (249, 218), (250, 218), (251, 218), (251, 217), (252, 217), (253, 217), (254, 217), (254, 216)], [(98, 37), (99, 37), (100, 37), (101, 37), (102, 37), (102, 38), (103, 38), (103, 39), (104, 39), (104, 40), (105, 40), (106, 40), (106, 41), (107, 41), (107, 42), (108, 42), (109, 42), (109, 43), (110, 43), (110, 44), (111, 44), (111, 45), (112, 45), (112, 46), (113, 46), (114, 46), (115, 46), (115, 47), (116, 47), (116, 48), (117, 48), (118, 48), (118, 49), (119, 49), (119, 50), (120, 50), (121, 50), (121, 51), (122, 51), (123, 51), (123, 52), (124, 52), (124, 53), (125, 53), (126, 53), (126, 54), (127, 54), (127, 55), (128, 55), (128, 56), (129, 56), (129, 57), (130, 57), (131, 57), (131, 58), (132, 58), (132, 59), (133, 59), (133, 60), (134, 60), (135, 60), (135, 61), (136, 61), (137, 61), (137, 62), (138, 62), (138, 63), (139, 63), (140, 63), (140, 64), (141, 64), (142, 64), (142, 65), (143, 65), (144, 65), (144, 66), (145, 66), (145, 67), (146, 67), (146, 68), (147, 68), (147, 69), (148, 69), (149, 69), (149, 70), (150, 70), (151, 70), (151, 71), (152, 71), (152, 72), (152, 73), (153, 73), (153, 74), (154, 74), (155, 74), (155, 75), (156, 75), (157, 75), (157, 76), (158, 76), (158, 77), (159, 77), (160, 77), (160, 78), (161, 78), (162, 78), (162, 79), (163, 79), (164, 79), (164, 80), (165, 80), (165, 81), (166, 81), (166, 82), (167, 82), (167, 83), (167, 84), (167, 85), (167, 86), (167, 87), (166, 87), (166, 88), (166, 89), (165, 89), (165, 90), (165, 91), (165, 92), (164, 92), (164, 93), (163, 93), (163, 94), (162, 94), (162, 95), (161, 95), (161, 96), (161, 97), (160, 97), (160, 98), (159, 98), (159, 99), (158, 99), (158, 100), (157, 100), (157, 101), (156, 101), (156, 102), (155, 102), (155, 103), (155, 104), (154, 104), (154, 105), (154, 106), (153, 106), (153, 107), (152, 107), (152, 108), (151, 108), (150, 108), (150, 109), (149, 109), (149, 110), (148, 110), (147, 110), (147, 111), (146, 111), (146, 112), (145, 112), (144, 112), (143, 112), (142, 112), (141, 112), (140, 112), (139, 112), (139, 111), (138, 111), (137, 111), (137, 110), (136, 110), (135, 110), (135, 109), (134, 109), (134, 108), (133, 108), (132, 108), (132, 107), (131, 107), (131, 106), (130, 106), (129, 106), (129, 105), (128, 105), (127, 105), (127, 104), (126, 104), (125, 104), (124, 104), (124, 103), (123, 103), (122, 103), (122, 102), (121, 102), (120, 102), (120, 101), (119, 101), (119, 100), (118, 100), (118, 99), (117, 99), (116, 99), (116, 98), (115, 98), (115, 97), (114, 97), (114, 96), (113, 96), (112, 96), (112, 95), (111, 95), (111, 94), (110, 94), (109, 94), (109, 93), (108, 93), (108, 92), (107, 92), (106, 92), (106, 91), (105, 91), (104, 91), (104, 90), (103, 90), (102, 90), (102, 89), (101, 89), (101, 88), (101, 87), (100, 87), (100, 86), (99, 86), (99, 85), (98, 85), (98, 84), (97, 84), (97, 83), (96, 83), (96, 82), (95, 82), (95, 81), (95, 80), (94, 80), (94, 79), (93, 79), (93, 78), (93, 77), (92, 77), (92, 76), (92, 75), (91, 75), (91, 74), (91, 73), (90, 73), (90, 72), (89, 72), (89, 71), (89, 70), (89, 69), (89, 68), (88, 68), (88, 67), (88, 66), (88, 65), (87, 65), (87, 64), (87, 63), (87, 62), (87, 61), (87, 60), (86, 60), (86, 59), (87, 59), (87, 58), (87, 57), (88, 57), (88, 56), (88, 55), (88, 54), (88, 53), (89, 53), (89, 52), (89, 51), (89, 50), (89, 49), (90, 49), (90, 48), (90, 47), (91, 47), (91, 46), (91, 45), (92, 45), (92, 44), (92, 43), (92, 42), (93, 42), (93, 41), (94, 41), (94, 40), (95, 40), (95, 39), (96, 39), (97, 39), (97, 38), (98, 38), (98, 37)], [(61, 1), (62, 1), (63, 1), (64, 1), (65, 1), (66, 1), (67, 1), (68, 1), (69, 1), (70, 1), (71, 1), (72, 1), (73, 1), (74, 1), (75, 1), (76, 1), (77, 1), (78, 1), (79, 1), (80, 1), (81, 1), (81, 2), (82, 2), (82, 3), (83, 3), (84, 3), (84, 4), (85, 4), (86, 4), (86, 5), (87, 5), (88, 5), (89, 5), (89, 6), (90, 6), (91, 6), (91, 7), (91, 8), (91, 9), (91, 10), (91, 11), (90, 11), (90, 12), (90, 13), (90, 14), (90, 15), (90, 16), (90, 17), (90, 18), (90, 19), (90, 20), (90, 21), (90, 22), (90, 23), (89, 23), (89, 24), (89, 25), (89, 26), (89, 27), (88, 27), (88, 28), (87, 28), (87, 29), (86, 29), (86, 30), (85, 30), (85, 31), (84, 31), (83, 31), (83, 32), (83, 33), (83, 34), (83, 35), (82, 35), (82, 36), (81, 36), (81, 35), (80, 35), (79, 35), (78, 35), (77, 35), (77, 36), (76, 36), (76, 37), (76, 38), (76, 39), (75, 39), (75, 40), (75, 41), (76, 41), (77, 41), (77, 42), (77, 43), (78, 43), (78, 44), (78, 45), (78, 46), (78, 47), (78, 48), (78, 49), (78, 50), (78, 51), (77, 51), (77, 52), (77, 53), (76, 53), (76, 54), (76, 55), (75, 55), (74, 55), (73, 55), (72, 55), (71, 55), (70, 55), (69, 55), (68, 55), (67, 55), (67, 54), (66, 54), (65, 54), (65, 53), (64, 53), (64, 52), (63, 52), (62, 52), (62, 51), (61, 51), (61, 50), (60, 50), (59, 50), (59, 49), (58, 49), (58, 48), (57, 48), (56, 48), (56, 47), (55, 47), (55, 46), (54, 46), (53, 46), (53, 45), (52, 45), (52, 44), (51, 44), (50, 44), (50, 43), (49, 43), (49, 42), (48, 42), (48, 41), (47, 41), (46, 41), (46, 40), (45, 40), (45, 39), (44, 39), (43, 39), (43, 38), (42, 38), (42, 37), (41, 37), (41, 36), (40, 36), (39, 36), (39, 35), (38, 35), (38, 34), (37, 34), (37, 33), (36, 33), (35, 33), (35, 32), (34, 32), (34, 31), (33, 31), (32, 31), (32, 30), (31, 30), (31, 29), (30, 29), (30, 28), (29, 28), (28, 28), (28, 27), (27, 27), (27, 26), (26, 26), (26, 25), (25, 25), (25, 24), (24, 24), (24, 23), (23, 23), (22, 23), (22, 22), (21, 22), (20, 22), (20, 21), (19, 21), (19, 20), (19, 19), (18, 19), (18, 18), (17, 18), (16, 18), (16, 17), (15, 17), (15, 16), (15, 15), (14, 15), (14, 14), (14, 13), (14, 12), (15, 12), (15, 11), (16, 11), (16, 10), (16, 9), (17, 9), (17, 8), (18, 8), (18, 7), (18, 6), (19, 6), (19, 5), (20, 5), (21, 5), (22, 5), (23, 5), (23, 4), (24, 4), (24, 5), (25, 5), (26, 5), (27, 5), (28, 5), (28, 6), (29, 6), (30, 6), (30, 5), (31, 5), (32, 5), (33, 5), (33, 4), (34, 4), (34, 5), (35, 5), (36, 5), (37, 5), (38, 5), (38, 6), (39, 6), (39, 7), (40, 7), (41, 7), (42, 7), (43, 7), (44, 7), (45, 7), (45, 8), (46, 8), (47, 8), (47, 7), (48, 7), (49, 7), (50, 7), (51, 7), (51, 6), (52, 6), (53, 6), (54, 6), (54, 5), (55, 5), (56, 5), (56, 4), (57, 4), (57, 3), (58, 3), (59, 3), (59, 2), (60, 2), (61, 2), (61, 1)], [(231, 97), (232, 97), (233, 97), (234, 97), (234, 98), (235, 98), (236, 98), (237, 98), (238, 98), (238, 99), (239, 99), (240, 99), (240, 100), (241, 100), (241, 101), (242, 101), (242, 102), (243, 102), (244, 102), (244, 103), (245, 103), (245, 104), (246, 104), (247, 104), (247, 105), (248, 105), (248, 106), (249, 106), (249, 107), (249, 108), (249, 109), (248, 109), (248, 110), (248, 111), (247, 111), (247, 112), (247, 113), (246, 113), (246, 114), (245, 114), (245, 115), (244, 115), (244, 116), (243, 116), (243, 117), (242, 117), (242, 118), (241, 118), (241, 119), (240, 119), (239, 119), (238, 119), (237, 119), (236, 119), (235, 119), (235, 118), (234, 118), (233, 118), (233, 117), (232, 117), (232, 116), (231, 116), (231, 115), (230, 115), (230, 114), (229, 114), (229, 113), (228, 113), (228, 112), (227, 112), (227, 111), (227, 110), (227, 109), (227, 108), (226, 108), (226, 107), (227, 107), (227, 106), (227, 105), (227, 104), (227, 103), (227, 102), (227, 101), (227, 100), (227, 99), (228, 99), (229, 99), (230, 99), (230, 98), (231, 98), (231, 97)], [(26, 2), (27, 2), (28, 2), (29, 2), (30, 2), (31, 2), (32, 2), (33, 2), (34, 2), (35, 2), (36, 2), (37, 2), (38, 2), (39, 2), (40, 2), (41, 2), (42, 2), (43, 2), (44, 2), (45, 2), (46, 2), (47, 2), (48, 2), (49, 2), (50, 2), (51, 2), (52, 2), (53, 2), (54, 2), (55, 2), (56, 2), (57, 2), (58, 2), (59, 2), (60, 2), (61, 2), (62, 2), (63, 2), (64, 2), (65, 2), (66, 2), (67, 2), (68, 2), (69, 2), (70, 2), (71, 2), (72, 2), (73, 2), (74, 2), (75, 2), (76, 2), (77, 2), (78, 2), (79, 2), (80, 2), (81, 2), (82, 2), (83, 2), (84, 2), (85, 2), (86, 2), (87, 2), (88, 2), (89, 2), (89, 3), (89, 4), (89, 5), (90, 5), (90, 6), (91, 6), (91, 7), (92, 7), (92, 8), (93, 8), (93, 9), (94, 9), (94, 10), (95, 10), (95, 11), (95, 12), (96, 12), (96, 13), (97, 13), (97, 14), (97, 15), (98, 15), (98, 16), (99, 16), (99, 17), (99, 18), (100, 18), (100, 19), (101, 19), (101, 20), (101, 21), (102, 21), (102, 22), (103, 22), (103, 23), (104, 23), (104, 24), (105, 24), (105, 25), (106, 25), (106, 26), (106, 27), (107, 27), (107, 28), (108, 28), (108, 29), (108, 30), (109, 30), (109, 31), (110, 31), (110, 32), (111, 32), (111, 33), (111, 34), (112, 34), (113, 34), (113, 35), (114, 35), (114, 36), (115, 36), (116, 36), (116, 37), (117, 37), (117, 38), (118, 38), (118, 39), (119, 39), (119, 40), (120, 40), (120, 41), (121, 41), (121, 42), (122, 42), (122, 43), (123, 43), (123, 44), (124, 44), (124, 45), (124, 46), (125, 46), (125, 47), (126, 47), (126, 48), (127, 48), (128, 48), (128, 49), (129, 49), (129, 50), (130, 50), (130, 51), (131, 51), (131, 52), (132, 52), (132, 53), (133, 53), (133, 54), (134, 54), (135, 54), (135, 55), (135, 56), (136, 56), (136, 57), (137, 57), (137, 58), (138, 58), (138, 59), (139, 59), (140, 59), (141, 59), (141, 60), (142, 60), (143, 60), (144, 60), (144, 61), (145, 61), (146, 61), (146, 62), (147, 62), (148, 62), (149, 62), (149, 63), (150, 63), (151, 63), (152, 63), (152, 64), (153, 64), (154, 64), (155, 64), (156, 64), (157, 64), (158, 64), (159, 64), (159, 65), (160, 65), (160, 66), (161, 66), (161, 67), (162, 67), (163, 67), (163, 68), (164, 68), (164, 69), (165, 69), (166, 69), (166, 70), (167, 70), (167, 71), (168, 71), (168, 72), (169, 72), (169, 73), (169, 74), (170, 74), (170, 75), (171, 75), (171, 76), (171, 77), (172, 77), (172, 78), (172, 79), (172, 80), (172, 81), (172, 82), (172, 83), (172, 84), (172, 85), (171, 85), (171, 86), (171, 87), (171, 88), (170, 88), (170, 89), (170, 90), (169, 90), (169, 91), (168, 91), (168, 92), (168, 93), (167, 93), (167, 94), (166, 94), (166, 95), (165, 95), (165, 96), (164, 96), (164, 97), (163, 97), (163, 98), (163, 99), (162, 99), (162, 100), (161, 100), (161, 101), (161, 102), (160, 102), (160, 103), (160, 104), (160, 105), (159, 105), (159, 106), (159, 107), (158, 107), (157, 107), (157, 108), (156, 108), (155, 108), (154, 108), (154, 109), (153, 109), (152, 109), (151, 109), (150, 109), (149, 109), (148, 109), (147, 109), (146, 109), (145, 109), (144, 109), (143, 109), (142, 109), (141, 109), (140, 109), (139, 109), (139, 108), (138, 108), (137, 108), (136, 108), (135, 108), (134, 108), (133, 108), (133, 107), (132, 107), (131, 107), (130, 107), (130, 106), (129, 106), (128, 106), (128, 105), (127, 105), (126, 105), (126, 104), (125, 104), (125, 103), (124, 103), (123, 103), (123, 102), (122, 102), (122, 101), (121, 101), (120, 101), (120, 100), (119, 100), (119, 99), (118, 99), (117, 99), (117, 98), (116, 98), (116, 97), (115, 97), (114, 97), (114, 96), (113, 96), (112, 96), (112, 95), (111, 95), (111, 94), (110, 94), (109, 94), (109, 93), (108, 93), (108, 92), (107, 92), (107, 91), (106, 91), (105, 91), (105, 90), (104, 90), (103, 90), (103, 89), (102, 89), (102, 88), (101, 88), (101, 87), (100, 87), (100, 86), (99, 86), (99, 85), (98, 85), (98, 84), (97, 84), (97, 83), (96, 83), (96, 82), (96, 81), (95, 81), (95, 80), (95, 79), (94, 79), (94, 78), (94, 77), (93, 77), (93, 76), (92, 76), (92, 75), (92, 74), (91, 74), (91, 73), (90, 73), (90, 72), (89, 72), (89, 71), (89, 70), (88, 70), (88, 69), (87, 69), (87, 68), (86, 68), (86, 67), (86, 66), (85, 66), (85, 65), (84, 65), (84, 64), (83, 64), (83, 63), (82, 63), (82, 62), (81, 62), (81, 61), (80, 61), (80, 60), (80, 59), (79, 59), (79, 58), (78, 58), (78, 57), (77, 57), (76, 57), (76, 56), (75, 56), (75, 55), (74, 55), (74, 54), (73, 54), (73, 53), (72, 53), (71, 53), (71, 52), (70, 52), (70, 51), (69, 51), (68, 51), (67, 51), (67, 50), (66, 50), (65, 50), (64, 50), (64, 49), (63, 49), (62, 49), (62, 48), (61, 48), (60, 48), (60, 47), (59, 47), (58, 47), (57, 47), (57, 46), (56, 46), (55, 46), (55, 45), (54, 45), (53, 45), (52, 45), (52, 44), (51, 44), (50, 44), (50, 43), (49, 43), (48, 43), (48, 42), (47, 42), (46, 42), (46, 41), (45, 41), (44, 41), (43, 41), (43, 40), (42, 40), (42, 39), (41, 39), (40, 39), (40, 38), (39, 38), (39, 37), (38, 37), (38, 36), (37, 36), (37, 35), (36, 35), (36, 34), (35, 34), (34, 34), (34, 33), (33, 33), (32, 33), (31, 33), (30, 33), (30, 32), (29, 32), (28, 32), (27, 32), (26, 32), (26, 31), (26, 30), (26, 29), (26, 28), (26, 27), (26, 26), (26, 25), (26, 24), (26, 23), (26, 22), (26, 21), (26, 20), (26, 19), (26, 18), (26, 17), (26, 16), (26, 15), (26, 14), (26, 13), (26, 12), (26, 11), (26, 10), (26, 9), (26, 8), (26, 7), (26, 6), (26, 5), (26, 4), (26, 3), (26, 2)], [(160, 80), (161, 80), (162, 80), (163, 80), (164, 80), (164, 81), (165, 81), (166, 81), (166, 82), (167, 82), (168, 82), (168, 83), (169, 83), (169, 84), (170, 84), (170, 85), (170, 86), (170, 87), (169, 87), (169, 88), (168, 88), (168, 89), (168, 90), (167, 90), (167, 91), (166, 91), (166, 92), (166, 93), (165, 93), (165, 94), (165, 95), (164, 95), (164, 96), (163, 96), (163, 97), (163, 98), (163, 99), (162, 99), (162, 100), (161, 100), (161, 101), (160, 101), (160, 102), (159, 102), (159, 103), (158, 103), (158, 104), (157, 104), (157, 105), (156, 105), (156, 106), (155, 106), (155, 107), (154, 107), (153, 107), (152, 107), (152, 108), (151, 108), (151, 107), (150, 107), (150, 106), (149, 106), (149, 105), (148, 105), (148, 104), (148, 103), (148, 102), (148, 101), (148, 100), (148, 99), (148, 98), (149, 98), (149, 97), (149, 96), (149, 95), (149, 94), (150, 94), (150, 93), (150, 92), (151, 92), (151, 91), (151, 90), (152, 90), (152, 89), (152, 88), (152, 87), (153, 87), (154, 87), (154, 86), (155, 86), (155, 85), (156, 85), (157, 85), (157, 84), (157, 83), (158, 83), (158, 82), (159, 82), (159, 81), (160, 81), (160, 80)]]

    def predict_array(self, img_data: np.ndarray, extent=None, do_rectangularization=True, tile=None) \
            -> List[List[Tuple[int, int]]]:
        if not self._model:
            print("Loading model")
            inference_config = self.InferenceConfig()
            # Create model in training mode
            model = modellib.MaskRCNN(mode="inference", config=inference_config, model_dir="log")
            model.load_weights(self.weights_path, by_name=True)
            self._model = model

        model = self._model
        print("Predicting...")
        res = model.detect([img_data], verbose=1)
        print("Prediction done")
        print("Extracting contours...")
        point_sets = self._get_contours(masks=res[0]['masks'])
        print("Contours extracted")

        point_sets_mapped = []
        for points in point_sets:
            pp = map(lambda p: (p[0]+tile[0]*256, p[1]+tile[1]*256), points)
            point_sets_mapped.append(pp)
        point_sets = point_sets_mapped

        rectangularized_outlines = []
        if do_rectangularization:
            for p in point_sets:
                reg = rectangularize(p)
                rectangularized_outlines.append(reg)
        else:
            rectangularized_outlines.extend(point_sets)
        if extent:
            rectangularized_outlines = map(lambda outline: georeference(outline, extent), rectangularized_outlines)
        return rectangularized_outlines

    def predict_path(self, img_path: str, extent=None) -> List[List[Tuple[int, int]]]:
        img = Image.open(img_path)
        data = np.asarray(img, dtype="uint8")
        return self.predict_array(img_data=data, extent=extent)

    @staticmethod
    def _get_contours(masks: np.ndarray) -> List[List[Tuple[int, int]]]:
        contours: List[List[Tuple[int, int]]] = []
        for i in range(masks.shape[-1]):
            mask = masks[:, :, i]
            from skimage.draw import polygon_perimeter
            from skimage.measure import find_contours
            conts = find_contours(mask, 0.5)
            for c in conts:
                rr, cc = polygon_perimeter(c[:, 0], c[:, 1], shape=mask.shape, clip=False)
                points = tuple(zip(cc, rr))
                contours.append(points)
        return contours
